
"""
Phase 1부터 구현 시작해줘 
"""

● Phase 1은 두 작업입니다. 병렬로 진행합니다.

  ---
  Phase 1 결과

  생성: src/types/site-config.ts
  UserAttribute  — 4가지 판별 방법 유니온 타입
  SiteConfig     — hostname, messageSelector, userAttribute, contentSelector,
                   ignoreSelector, deduplicate, scrollToLoad
  ChatFormat     — userTitleFormat, aiTitleFormat, turnSeparator, qaSeparator

  수정: src/types/types.ts
  Template에 선택적 필드 5개 추가:
    siteConfig?   — 있으면 AI chat 템플릿으로 동작
    chatFormat?   — 대화 출력 형식
    emoji?        — AI 아이콘
    authorLabel?  — AI 이름
    titlePrefix?  — 마크다운 H1 제목

  빌드 통과 (webpack compiled successfully). Phase 2로 진행할까요?

=======================

"""
Phase 2 구현해줘 
"""

● content.ts는 별도 entry point — ai-chat-extractor.ts를 import할 때 Turndown이 content.js에 묻어들지 않도록, 외부 라이브러리 없는 자체 DOM 파서로 구현합니다. 그다음 markdown-converter.ts에 Turndown 코드블록 언어 감지룰을 추가합니다.

● 두 파일을 병렬로 작업합니다.
  ---
  Phase 2 결과

  신규: src/utils/ai-chat-extractor.ts

  외부 의존성 없는 자체 DOM 파서로 구현 (content.js 번들 보호).

  ┌─────────────────────────────────────────────────┬──────────┬──────────────────────────────────────────┐   
  │                      함수                       │ 컨텍스트 │                   역할                   │   
  ├─────────────────────────────────────────────────┼──────────┼──────────────────────────────────────────┤   
  │ detectUser(msg, userAttr, index)                │ content  │ 4가지 전략으로 사용자 메시지 판별        │   
  ├─────────────────────────────────────────────────┼──────────┼──────────────────────────────────────────┤   
  │ scrollAllTurns(messageSelector)                 │ content  │ AI Studio 가상 스크롤 대응               │   
  ├─────────────────────────────────────────────────┼──────────┼──────────────────────────────────────────┤   
  │ convertAIChatToMarkdown(el, ignoreSelector?)    │ content  │ DOM → 마크다운 (코드블록 언어 감지 포함) │   
  ├─────────────────────────────────────────────────┼──────────┼──────────────────────────────────────────┤   
  │ extractAIChatContent(siteConfig, chatFormat)    │ content  │ 페이지 전체 대화 추출 오케스트레이션     │   
  ├─────────────────────────────────────────────────┼──────────┼──────────────────────────────────────────┤   
  │ buildAIChatVariables(markdown, count, template) │ popup    │ {{chatContent}} 등 변수 맵 생성          │   
  └─────────────────────────────────────────────────┴──────────┴──────────────────────────────────────────┘   

  수정: src/utils/markdown-converter.ts

  codeBlockLanguageDetection Turndown 룰 추가:
  - <pre> 직전 형제 요소의 텍스트에서 언어명 감지 (ChatGPT 패턴)
  - .code-block-decoration > span 에서 언어명 감지 (Gemini 패턴)
  - GFM 플러그인과 충돌 없음 (language-* 클래스 있으면 GFM이 처리, 없으면 이 룰이 처리)

  Phase 3 (content.ts에 extractAIChat 메시지 핸들러 추가) 로 진행할까요?

==============================

"""
Phase 3 구현해줘 
"""


● 빌드 성공. 번들 변화를 확인합니다.

  ┌───────────────┬──────────┬──────────┬─────────────────────────────────────────┐
  │     번들      │   이전   │   이후   │                  변화                   │
  ├───────────────┼──────────┼──────────┼─────────────────────────────────────────┤
  │ content.js    │ 1.26 KiB │ 6.11 KiB │ +4.85 KiB (ai-chat-extractor 포함)      │
  ├───────────────┼──────────┼──────────┼─────────────────────────────────────────┤
  │ popup.js      │ 89.5 KiB │ 89.5 KiB │ 변화 없음 (buildAIChatVariables 미사용) │
  ├───────────────┼──────────┼──────────┼─────────────────────────────────────────┤
  │ background.js │ 671 B    │ 671 B    │ 변화 없음                               │
  └───────────────┴──────────┴──────────┴─────────────────────────────────────────┘

  외부 라이브러리 없이 +4.85 KB — 예상 범위 내입니다.

● Phase 3 완료입니다.

  ---
  Phase 3 결과

  수정: src/content.ts

  추가된 내용:

  import { extractAIChatContent } from './utils/ai-chat-extractor';

  새 메시지 핸들러 "extractAIChat":

  popup → content script 에 전송:
    { action: "extractAIChat", siteConfig: SiteConfig, chatFormat: ChatFormat }

  content script 처리:
    1. siteConfig / chatFormat 존재 여부 검증
    2. extractAIChatContent(siteConfig, chatFormat) 비동기 실행
       - scrollToLoad: true 이면 scrollAllTurns() 먼저
       - 메시지 순회 → 마크다운 조립
    3. { markdown: string, messageCount: number } 반환
       (에러 시: { error: string })

  return true → 채널 유지 (비동기 응답 대기)

  기존 핸들러 (getPageContent, extractContent) 는 무변경.

  Phase 4 (변수 파이프라인 통합 — content-extractor.ts + popup.ts 흐름 분기) 로 진행할까요?

==============

"""
Phase 4 진행해줘
"""

● 빌드 성공. 최종 번들 크기를 정리합니다.                                                                        
  ┌───────────────┬──────────┬──────────┬───────────────────────────────────────────────────────┐             
  │     번들      │ Phase 3  │ Phase 4  │                         변화                          │               ├───────────────┼──────────┼──────────┼───────────────────────────────────────────────────────┤
  │ content.js    │ 6.11 KiB │ 6.11 KiB │ 변화 없음                                             │             
  ├───────────────┼──────────┼──────────┼───────────────────────────────────────────────────────┤
  │ popup.js      │ 89.5 KiB │ 90.5 KiB │ +1 KB (sendExtractAIChat + buildAIChatVariables 포함) │
  ├───────────────┼──────────┼──────────┼───────────────────────────────────────────────────────┤
  │ background.js │ 671 B    │ 671 B    │ 변화 없음                                             │
  └───────────────┴──────────┴──────────┴───────────────────────────────────────────────────────┘

● Phase 4 완료입니다.       
    
  ---                                                                                                           Phase 4 결과                                                                                                
                                                                                                                src/utils/content-extractor.ts                                                                                                                                                                                            
  추가: sendExtractAIChat(tabId, siteConfig, chatFormat)
  - chrome.tabs.sendMessage → content script의 extractAIChat 핸들러 호출
  - 반환: { markdown, messageCount } 또는 에러 시 null

  확장: initializePageContent(..., extraVariables?)

  ┌───────────────────────┬────────────────────────────────────────────────────────────┐
  │         변경          │                            내용                            │
  ├───────────────────────┼────────────────────────────────────────────────────────────┤
  │ 시그니처              │ extraVariables?: Record<string, string> 파라미터 추가      │
  ├───────────────────────┼────────────────────────────────────────────────────────────┤
  │ Readability 실패 처리 │ extraVariables 있으면 계속 진행, 없으면 기존대로 null 반환 │
  ├───────────────────────┼────────────────────────────────────────────────────────────┤
  │ markdownBody          │ Readability 결과 있으면 변환, 없으면 ''                    │
  ├───────────────────────┼────────────────────────────────────────────────────────────┤
  │ 반환 직전             │ Object.assign(currentVariables, extraVariables) 병합       │
  └───────────────────────┴────────────────────────────────────────────────────────────┘

  src/core/popup.ts

  import 추가
  sendExtractAIChat (content-extractor)
  buildAIChatVariables (ai-chat-extractor)

  메인 초기화 / 템플릿 변경 핸들러 — 공통 흐름
  extractPageContent()                       ← 기존 HTML 수집
  findMatchingTemplate()                     ← 템플릿 매칭 (앞으로 이동)
  if (siteConfig && chatFormat):
    sendExtractAIChat()  →  buildAIChatVariables()  →  extraVariables
  initializePageContent(..., extraVariables) ← 변수 맵 구축 + 병합
  initializeTemplateFields()                 ← UI 렌더링

  Phase 5 (Settings UI — siteConfig 편집 폼) 로 진행할까요?

===============

"""
Phase 5 진행해줘
"""


  Phase 5 완료                                                                                                            
                                                                                                                            변경 파일 3개                                                                                                                                                                                                                                     
  src/settings.html
  - #template-editor 마지막에 <details class="ai-chat-settings"> 블록 추가
  - 4개 섹션: 표시 정보 (emoji, authorLabel, titlePrefix), 사이트 설정 (hostname, messageSelector, contentSelector,       
  ignoreSelector, deduplicate, scrollToLoad), 사용자 메시지 판별 (판별 방식 select + 동적 필드 div), 대화 형식
  (userTitleFormat, aiTitleFormat, turnSeparator, qaSeparator)

  src/managers/template-ui.ts
  - import { SiteConfig, ChatFormat, UserAttribute } 추가
  - populateAIChatFields(template) — 폼에 기존 값 채우기
  - renderUserAttrFields(existingAttr?) — 판별 방식에 따라 동적 입력 필드 렌더링 (4가지 타입)
  - readUserAttribute(type) — 폼 → UserAttribute 유니온 타입 변환
  - readAIChatFields(template) — 폼 → template.siteConfig / chatFormat 저장 (hostname 비어있으면 undefined로 초기화)      
  - showTemplateEditor() — populateAIChatFields 호출, chat-user-attr-type change 이벤트 리스너 등록
  - updateTemplateFromForm() — readAIChatFields 호출

  src/styles/settings.scss
  - details.ai-chat-settings — border, border-radius, summary 토글 스타일, [open] 상태 화살표 회전
  - .ai-chat-settings-body h4 — 섹션 소제목 스타일 (uppercase, letter-spacing)

  번들 크기

  ┌─────────────┬──────────┬──────────────────────┐
  │    파일     │ Phase 4  │       Phase 5        │
  ├─────────────┼──────────┼──────────────────────┤
  │ settings.js │ 32.6 KiB │ 40 KiB               │
  ├─────────────┼──────────┼──────────────────────┤
  │ content.js  │ 6.11 KiB │ 6.11 KiB (변화 없음) │
  └─────────────┴──────────┴──────────────────────┘

=============

"""
Phase 6 구현해줘
"""

● Phase 6 완료. 구현 내용 요약:                                                                                           
                                                                                                                          
  ---                                                                                                                       Phase 6 완료                                                                                                            
                                                                                                                            변경 파일 2개                                                                                                                                                                                                                                     
  src/data/default-ai-chat-templates.ts (신규)

  5개 기본 AI Chat 템플릿 — config.js의 DEFAULT_SITE_CONFIGS 데이터를 TypeScript Template 형식으로 이식.

  ┌─────────────────────┬──────────────────┬────────────────────────┬──────────────────────────────────────┐
  │         ID          │       이름       │         호스트         │          userAttribute 방식          │
  ├─────────────────────┼──────────────────┼────────────────────────┼──────────────────────────────────────┤
  │ default-ai-chatgpt  │ ChatGPT          │ chatgpt.com            │ attr (data-message-author-role=user) │
  ├─────────────────────┼──────────────────┼────────────────────────┼──────────────────────────────────────┤
  │ default-ai-claude   │ Claude           │ claude.ai              │ attr (data-testid=user-message)      │
  ├─────────────────────┼──────────────────┼────────────────────────┼──────────────────────────────────────┤
  │ default-ai-gemini   │ Gemini           │ gemini.google.com      │ tag (user-query)                     │
  ├─────────────────────┼──────────────────┼────────────────────────┼──────────────────────────────────────┤
  │ default-ai-aistudio │ Google AI Studio │ aistudio.google.com    │ containerSelector + scrollToLoad     │
  ├─────────────────────┼──────────────────┼────────────────────────┼──────────────────────────────────────┤
  │ default-ai-genspark │ Genspark         │ http://www.genspark.ai │ htmlMatch + deduplicate              │
  └─────────────────────┴──────────────────┴────────────────────────┴──────────────────────────────────────┘

  각 템플릿 공통 구성:
  - path: AI/<SiteName> 폴더
  - noteContentFormat: {{chatContent}}
  - noteNameFormat: {{titlePrefix}} — {{title}}
  - properties: title, source, model, messageCount, createdAt, tags

  src/managers/template-manager.ts (수정)
  - loadTemplates() — template_list 비어있을 때: 기존 웹 클리핑 기본 템플릿 1개 + AI chat 템플릿 5개 함께 생성

  번들 크기

  ┌─────────────┬──────────┬────────────────────────────────────┐
  │    파일     │ Phase 5  │              Phase 6               │
  ├─────────────┼──────────┼────────────────────────────────────┤
  │ popup.js    │ 90.5 KiB │ 95.9 KiB (+5.4 KiB, 템플릿 데이터) │
  ├─────────────┼──────────┼────────────────────────────────────┤
  │ settings.js │ 40 KiB   │ 45.4 KiB (+5.4 KiB, 동일 데이터)   │
  ├─────────────┼──────────┼────────────────────────────────────┤
  │ content.js  │ 6.11 KiB │ 6.11 KiB (변화 없음)               │
  └─────────────┴──────────┴────────────────────────────────────┘


=========================

"""
Phase 7 구현해줘
"""

  Phase 7 완료 요약                                                                                                                                          
                                                                                                                                                               수정된 버그들:                                                                                                                                                                                                                                                                                                          
  ┌─────┬──────────────────────────┬─────────────────────────────────────────────────────────┬───────────────────────┐
  │  #  │           파일           │                          버그                           │         수정          │
  ├─────┼──────────────────────────┼─────────────────────────────────────────────────────────┼───────────────────────┤
  │ 1   │ content-extractor.ts     │ extractPageContent — chrome.runtime.lastError 미체크    │ lastError 체크 추가   │
  ├─────┼──────────────────────────┼─────────────────────────────────────────────────────────┼───────────────────────┤
  │ 2   │ content-extractor.ts     │ extractContentBySelector — 동일 문제                    │ lastError 체크 추가   │
  ├─────┼──────────────────────────┼─────────────────────────────────────────────────────────┼───────────────────────┤
  │ 3   │ popup.ts (초기 로드)     │ messageCount === 0 시 경고 없음                         │ console.warn 추가     │
  ├─────┼──────────────────────────┼─────────────────────────────────────────────────────────┼───────────────────────┤
  │ 4   │ popup.ts (드롭다운 변경) │ 동일 문제                                               │ console.warn 추가     │
  ├─────┼──────────────────────────┼─────────────────────────────────────────────────────────┼───────────────────────┤
  │ 5   │ ai-chat-extractor.ts     │ 0개 메시지일 때도 비어있지 않은 마크다운 반환           │ 빈 문자열로 조기 반환 │
  ├─────┼──────────────────────────┼─────────────────────────────────────────────────────────┼───────────────────────┤
  │ 6   │ template-ui.ts           │ AI chat 템플릿 → 일반 템플릿 전환 시 typeSelect 값 유지 │ 'attr'로 리셋         │
  └─────┴──────────────────────────┴─────────────────────────────────────────────────────────┴───────────────────────┘

  최종 빌드 결과:
  webpack compiled successfully
  popup.js:     96.6 KiB
  settings.js:  45.5 KiB
  content.js:    6.2 KiB
  background.js: 671 bytes

  이제 dist/ 폴더를 chrome://extensions/ → "Load unpacked"으로 로드하여 실제 AI chat 사이트에서 테스트할 수 있습니다.

========================

"""
Phase 8 구현해줘
"""

